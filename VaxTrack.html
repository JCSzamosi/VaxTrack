<h1>Vax Track</h1>

<p>Tracking how quickly Canada is moving its vaccine supply into human beings. All
data are taken from <a href="https://covid19tracker.ca">covid19tracker.ca</a>. This 
analysis is at the dose level and does not distinguish between first and second
doses, or vaccine types.</p>

<h2>Setup</h2>

<p><details><summary>Click here to see the setup code</summary></p>

<p>Load packages and import data:</p>

<p>```r
knitr::opts<em>chunk$set(message = FALSE)
setwd('~/MyProjects/COVID19/VaxTrack/')
library(jsonlite)
library(tidyverse)
theme</em>set(theme<em>bw())
library(lubridate)
url = 'https://api.covid19tracker.ca/reports?fill</em>dates=true'
upd = fromJSON(url)
dat_can = upd$data</p>

<h1>head(dat_can)</h1>

<h1>tail(dat_can)</h1>

<p>summary(dat_can)
```</p>

<p>```</p>

<h2>date            change<em>cases  change</em>fatalities  change_tests</h2>

<h2>Length:435         Min.   :   1   Min.   :  0.00    Min.   : -5768</h2>

<h2>Class :character   1st Qu.: 457   1st Qu.:  8.00    1st Qu.: 28952</h2>

<h2>Mode  :character   Median :1536   Median : 34.00    Median : 58903</h2>

<h2>Mean   :2441   Mean   : 55.77    Mean   : 65306</h2>

<h2>3rd Qu.:3922   3rd Qu.: 96.00    3rd Qu.: 99710</h2>

<h2>Max.   :9481   Max.   :228.00    Max.   :393941</h2>

<h2>NA's   :22     NA's   :22</h2>

<h2>change<em>hospitalizations change</em>criticals  change_recoveries</h2>

<h2>Min.   :-218.00         Min.   :-76.000   Min.   :    0.0</h2>

<h2>1st Qu.: -19.00         1st Qu.: -4.000   1st Qu.:  345.5</h2>

<h2>Median :   0.00         Median :  0.000   Median :  847.0</h2>

<h2>Mean   :   5.97         Mean   :  1.841   Mean   : 2133.5</h2>

<h2>3rd Qu.:  28.00         3rd Qu.:  6.500   3rd Qu.: 3210.5</h2>

<h2>Max.   : 467.00         Max.   :188.000   Max.   :23999.0</h2>

<h2> </h2>

<h2>change<em>vaccinations change</em>vaccinated  change<em>vaccines</em>distributed</h2>

<h2>Min.   :     0.0    Min.   :-32257.0   Min.   :     0</h2>

<h2>1st Qu.:     0.0    1st Qu.:   455.5   1st Qu.:     0</h2>

<h2>Median :     0.0    Median :  4818.0   Median :  3900</h2>

<h2>Mean   : 14386.2    Mean   :  6339.3   Mean   : 70571</h2>

<h2>3rd Qu.:   361.5    3rd Qu.: 10145.0   3rd Qu.: 50575</h2>

<h2>Max.   :219496.0    Max.   : 32068.0   Max.   :817830</h2>

<h2>NA's   :324        NA's   :315</h2>

<h2>total<em>cases      total</em>fatalities  total<em>tests       total</em>hospitalizations</h2>

<h2>Min.   :      1   Min.   :    0    Min.   :       2   Min.   :   0.0</h2>

<h2>1st Qu.:  72844   1st Qu.: 5344    1st Qu.: 1290244   1st Qu.: 328.5</h2>

<h2>Median : 129701   Median : 9151    Median : 6327940   Median :1370.0</h2>

<h2>Mean   : 287298   Mean   : 9829    Mean   : 9358803   Mean   :1602.6</h2>

<h2>3rd Qu.: 482466   3rd Qu.:13772    3rd Qu.:16682481   3rd Qu.:2524.0</h2>

<h2>Max.   :1008144   Max.   :23031    Max.   :28408246   Max.   :4879.0</h2>

<h2> </h2>

<h2>total<em>criticals total</em>recoveries total<em>vaccinations total</em>vaccinated</h2>

<h2>Min.   :  0.0   Min.   :     0   Min.   :      0    Min.   :  2173</h2>

<h2>1st Qu.: 69.5   1st Qu.: 34600   1st Qu.:      0    1st Qu.:105338</h2>

<h2>Median :249.0   Median :115054   Median :      0    Median :387694</h2>

<h2>Mean   :329.4   Mean   :247999   Mean   : 415034    Mean   :356598</h2>

<h2>3rd Qu.:559.5   3rd Qu.:394286   3rd Qu.:   1873    3rd Qu.:592002</h2>

<h2>Max.   :900.0   Max.   :928081   Max.   :6258003    Max.   :703660</h2>

<h2>NA's   :348</h2>

<h2>total<em>vaccines</em>distributed</h2>

<h2>Min.   :   3900</h2>

<h2>1st Qu.: 548955</h2>

<h2>Median :1253140</h2>

<h2>Mean   :2084313</h2>

<h2>3rd Qu.:2933320</h2>

<h2>Max.   :8468570</h2>

<h2>NA's   :323</h2>

<p>```</p>

<p>```r
dat<em>can$date = ymd(dat</em>can$date)</p>

<h1>summary(dat_can)</h1>

<p>dat<em>vax = (dat</em>can
           %>% filter(!is.na(total<em>vaccines</em>distributed))
           %>% select(date,change<em>vaccinations,
                   change</em>vaccines<em>distributed,total</em>vaccinations,
                   total<em>vaccines</em>distributed))</p>

<h1>dim(dat_vax)</h1>

<h1>head(dat_vax)</h1>

<p>```</p>

<p>Function definitions:</p>

<p>```r</p>

<h1>This is the least graceful way I could have done this, but it works.</h1>

<p>avg<em>wait = function(dat</em>vax){
    pos = 1
    dist = 0
    vaxxed = 0
    i = 0
    counted = 0
    avg<em>df = data.frame(Time = NA, Doses = NA, .vaxxed = NA,
                        .counted = NA, .leftover = NA,
                        .dist = NA, .pos = NA)
    for (i in 1:nrow(dat</em>vax)){
        leftover = dist - vaxxed
        dist = dat<em>vax[pos,'total</em>vaccines<em>distributed']
        vaxxed = dat</em>vax[i,'total<em>vaccinations']
        new</em>vaxxed = dat<em>vax[i,'change</em>vaccinations']
        if (vaxxed &lt;= dist){
            timediff = dat<em>vax[i, 'date'] - dat</em>vax[pos, 'date']
            avg<em>df = rbind(avg</em>df, data.frame(Time = timediff, 
                                              Doses = new<em>vaxxed,
                                              .vaxxed = vaxxed, 
                                              .counted = counted,
                                              .leftover = leftover,
                                              .dist = dist, .pos = pos))
            counted = counted + new</em>vaxxed
        } else {
            timediff = dat<em>vax[i, 'date'] - dat</em>vax[pos, 'date']
            avg<em>df = rbind(avg</em>df, data.frame(Time = timediff, Doses = leftover,
                                              .vaxxed = vaxxed, 
                                              .counted = counted,
                                              .leftover = leftover,
                                              .dist = dist, .pos = pos))
            counted = counted + leftover
            new<em>vaxxed = new</em>vaxxed - leftover
            pos = pos + 1
            dist = dat<em>vax[pos, 'total</em>vaccines<em>distributed']
            while (dist &lt; vaxxed){
                avail = dist - counted
                timediff = dat</em>vax[i, 'date'] - dat<em>vax[pos, 'date']
                avg</em>df = rbind(avg<em>df, data.frame(Time = timediff,
                                                  Doses = avail,
                                              .vaxxed = vaxxed, 
                                              .counted = counted,
                                              .leftover = leftover,
                                              .dist = dist, .pos = pos))
                counted = counted + avail
                new</em>vaxxed = new<em>vaxxed - avail
                pos = pos + 1
                dist = dat</em>vax[pos, 'total<em>vaccines</em>distributed']
                if (pos > i){
                    stop('pos > i')
                }
            }
            timediff = dat<em>vax[i, 'date'] - dat</em>vax[pos, 'date']
            avg<em>df = rbind(avg</em>df, data.frame(Time = timediff, Doses = new<em>vaxxed,
                                              .vaxxed = vaxxed, 
                                              .counted = counted,
                                              .leftover = leftover,
                                              .dist = dist, .pos = pos))
            counted = counted + new</em>vaxxed
        }
    }
    avg<em>df = na.omit(avg</em>df)
    return(avg_df)
}</p>

<p>roll<em>avg = function(x, n){
    if (length(x) &lt;= n){
        stop('vector needs to be longer than window')
    }
    v</em>avg = rep(NA, n-1)
    for (i in n:length(x)){
        avg = mean(x[(i-n+1):i], na.rm = TRUE)
        v<em>avg = c(v</em>avg, avg)
    }
    return(v_avg)
}</p>

<p>get_wait = function(df){
    wait = sum(df$Time*df$Doses)/sum(df$Doses)
}
```</p>

<p></details></p>

<h2>Vaccine Gap</h2>

<p><details><summary>code</summary></p>

<p><code>r
dist_tot = dat_vax[nrow(dat_vax),'total_vaccines_distributed']
admn_tot = dat_vax[nrow(dat_vax),'total_vaccinations']
msg = paste('So far Canada has distributed ', 
            format(dist_tot, nsmall = 1, big.mark = ','), 
            ' vaccine doses, and ',
            format(admn_tot, nsmall = 1, big.mark = ','), 
            ' of those have been administered.', sep = '')
msg1 = paste('This is a cumulative administration rate of ', 
            100*round(admn_tot/dist_tot, 4), '%', sep = '')
</code>
</details></p>

<p>```</p>

<h2>[1] "So far Canada has distributed 8,468,570 vaccine doses, and 6,258,003 of those have been administered."</h2>

<p>```</p>

<p>```</p>

<h2>[1] "This is a cumulative administration rate of 73.9%"</h2>

<p>```</p>

<p><details><summary>code</summary></p>

<p>```r</p>

<h1>head(dat_vax)</h1>

<p>dat<em>tot</em>long = (dat<em>vax
                %>% select(-change</em>vaccinations, 
                           -change<em>vaccines</em>distributed)
                %>% gather(Variable, Count, -date)
                %>% mutate(Variable = factor(Variable, 
                                             levels = c('total<em>vaccines</em>distributed',
                                                       'total_vaccinations'))))</p>

<h1>head(dat<em>tot</em>long)</h1>

<p>abs<em>adm = ggplot(dat</em>tot<em>long, aes(date, Count, fill = Variable)) +
    geom</em>area(alpha = 0.5, position = 'identity') +
    scale<em>fill</em>manual(values = c('sienna4', 'sienna1'), 
                      labels = c('doses distributed','doses administered'),
                      name = NULL) +
    xlab('Date') +
    ggtitle('Total cumulative doses distributed\nand administered over time')
abs_adm
```</p>

<p><img src="figure/unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3" title="" /></p>

<p>```r
dat<em>vax = (dat</em>vax
           %>% mutate(prop<em>dist = 
                    total</em>vaccinations/total<em>vaccines</em>distributed,
                   prop<em>7 = roll</em>avg(prop<em>dist, 7)))
prop</em>adm = ggplot(dat<em>vax, aes(date, prop</em>dist)) +
    geom_line() +
    xlab('Date') +
    ylab('Proportion Administered') +
    ggtitle('Instantaneous proportion of delivered doses\nthat have been administered')</p>

<p>prop<em>adm</em>7 = ggplot(dat<em>vax, aes(date, prop</em>7)) +
    geom_line() +
    xlab('Date') +
    ylab('Proportion Administered') +
    ggtitle('Rolling 7-day average of proportion of delivered doses\nthat have been administered')
```
</details></p>

<p><img src="figure/unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4" title="" />
<img src="figure/unnamed-chunk-5-1.png" alt="plot of chunk unnamed-chunk-5" title="" /><img src="figure/unnamed-chunk-5-2.png" alt="plot of chunk unnamed-chunk-5" title="" /></p>

<h2>Wait Times</h2>

<p><details><summary>code</summary></p>

<p><code>r
wt_df = avg_wait(dat_vax)
wait = get_wait(wt_df)
msg = paste('Vaccine doses have waited an average of', round(wait,1), 'days between being distributed and being administered.')
</code>
</details></p>

<p>```</p>

<h2>[1] "Vaccine doses have waited an average of 7.4 days between being distributed and being administered."</h2>

<p>```</p>

<p><details><summary>code</summary></p>

<p>```r
wait_df = data.frame(Wait = NA)</p>

<p>for(i in 2:nrow(dat<em>vax)){
    wait</em>df = rbind(wait<em>df, 
                    data.frame(Wait = get</em>wait(avg<em>wait(dat</em>vax[1:i,]))))
}
wait<em>df = na.omit(wait</em>df)</p>

<h1>head(wait_df)</h1>

<p>wait<em>df$Date = dat</em>vax[-1,'date']</p>

<p>wait<em>plt = ggplot(wait</em>df, aes(Date, Wait)) +
    geom_line() +
    ylab('Wait Time (Days)') +
    ggtitle('Cumulative average time it takes a vaccine dose\nto go from distribution to administration\nin Canada')
```
</details></p>

<p><img src="figure/unnamed-chunk-9-1.png" alt="plot of chunk unnamed-chunk-9" title="" /></p>

<p><details><summary>code</summary></p>

<p>```r
n = nrow(wt<em>df)
dist = wt</em>df[n,'.dist']
vaxxed = wt<em>df[n,'.vaxxed']
leftover = dist - vaxxed
pos = wt</em>df[n,'.pos']
timediff = today() - dat_vax[pos, 'date']</p>

<p>avg_wt = data.frame(Time = timediff, Doses = leftover)</p>

<h1>avg_wt</h1>

<p>for (i in (pos+1):nrow(dat<em>vax)){
    i = i + 1
    i
    dat</em>vax[i,]
    timediff = today() - dat<em>vax[i, 'date']
    timediff
    avg</em>wt = rbind(avg<em>wt,
                   data.frame(Time = timediff,
                           Doses = dat</em>vax[i, 'change<em>vaccines</em>distributed']))
    avg_wt
}</p>

<p>avg<em>wt = na.omit(avg</em>wt)</p>

<p>new<em>wt = sum(avg</em>wt$Time * avg<em>wt$Doses)/sum(avg</em>wt$Doses)</p>

<p>msg = paste('Current unadministerd doses have been waiting an average of',
            round(new_wt,1), 'days.')
```
</details></p>

<p>```</p>

<h2>[1] "Current unadministerd doses have been waiting an average of 1.9 days."</h2>

<p>```</p>

<hr />

<p><details><summary>code</summary></p>

<p><code>r
msg = paste('This website was last updated', today())
msg1 = paste('The most recent data are from', max(dat_vax$date))
</code>
</details></p>

<p>```</p>

<h2>[1] "This website was last updated 2021-04-03"</h2>

<p>```</p>

<p>```</p>

<h2>[1] "The most recent data are from 2021-04-03"</h2>

<p>```</p>
